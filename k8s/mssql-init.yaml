apiVersion: batch/v1
kind: Job
metadata:
  name: mssql-init
spec:
  backoffLimit: 4
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: init
          image: mcr.microsoft.com/mssql-tools
          env:
            - name: SA_PWD
              valueFrom:
                secretKeyRef: { name: mssql-secret, key: MSSQL_SA_PASSWORD }
          command: ["/bin/bash","-lc"]
          args:
            - |
              set -e
              until /opt/mssql-tools/bin/sqlcmd -S mssql -U sa -P "$SA_PWD" -Q "SELECT 1" >/dev/null 2>&1; do sleep 2; done
              /opt/mssql-tools/bin/sqlcmd -S mssql -U sa -P "$SA_PWD" -Q "
              IF DB_ID('Porty') IS NULL CREATE DATABASE [Porty];
              IF NOT EXISTS (SELECT * FROM sys.sql_logins WHERE name='Porty')
                CREATE LOGIN [Porty] WITH PASSWORD='IUSR_PORTY', CHECK_POLICY=OFF, CHECK_EXPIRATION=OFF;
              USE [Porty];
              IF NOT EXISTS (SELECT * FROM sys.database_principals WHERE name='Porty')
                CREATE USER [Porty] FOR LOGIN [Porty];
              EXEC sp_addrolemember N'db_owner', N'Porty';
              "
