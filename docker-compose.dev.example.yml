version: "3.9"

services:
  db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: porty-sql-dev
    environment:
      SA_PASSWORD: "mdp_SA_ssms_dev"
      ACCEPT_EULA: "Y"
    ports:
      - "1433:1433"
    volumes:
      - sql_data_dev:/var/opt/mssql
    networks:
      - web
    restart: always

  api:
    image: mcr.microsoft.com/dotnet/sdk:8.0
    working_dir: /src
    volumes:
      - ./api:/src
      - api_bin:/src/bin
      - api_obj:/src/obj
      - dotnet_nuget:/root/.nuget/packages
    environment:
      ASPNETCORE_ENVIRONMENT: "Development"
      ASPNETCORE_URLS: "http://0.0.0.0:8080"
      DOTNET_USE_POLLING_FILE_WATCHER: "true"
      ConnectionStrings__DefaultConnection: "Server=db;Database=Porty;User Id=sa;Password=YourStrong!Passw0rd;TrustServerCertificate=True;MultipleActiveResultSets=True"
    depends_on:
      - db
    ports:
      - "8080:8080"
    command: ["dotnet", "watch", "run", "--non-interactive"]
    networks:
      - web

  front:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./front:/app
      - front_node:/app/node_modules
    environment:
      HOST: "0.0.0.0"
      CHOKIDAR_USEPOLLING: "true"
      WATCHPACK_POLLING: "true"
      VITE_API_URL: "http://localhost:8080"
    ports:
      - "5173:5173"
    command: sh -c "npm i && npm run dev -- --host 0.0.0.0 --port 5173"
    depends_on:
      - api
    networks:
      - web

networks:
  web:

volumes:
  sql_data_dev:
  api_bin:
  api_obj:
  dotnet_nuget:
  front_node:
